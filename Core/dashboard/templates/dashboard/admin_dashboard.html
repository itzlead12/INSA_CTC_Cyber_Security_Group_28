{% extends 'dashboard/base.html' %}
{% load static %}
{% block title %}Admin Dashboard - WAF{% endblock %}

{% block content %}

<!-- Add this to your dashboard template near the top -->
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-800">Security Dashboard</h1>
    <p class="text-gray-600">Real-time monitoring and threat intelligence</p>
    <div id="connection-status" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
        <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
        Connecting...
    </div>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-red-100 text-red-600">
                <i class="fas fa-shield-alt text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Threats Blocked</p>
                <p id="total_blocked" class="text-2xl font-bold text-gray-900">{{ total_blocked }}</p>
            </div>
        </div>
        <div class="mt-4">
            <span id="recent_threats" class="text-sm text-red-600 font-medium">
                <i class="fas fa-arrow-up mr-1"></i>
                {{ recent_threats }} last 24h
            </span>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100 text-green-600">
                <i class="fas fa-check-circle text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Requests Allowed</p>
                <p id="total_allowed" class="text-2xl font-bold text-gray-900">{{ total_allowed }}</p>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                <i class="fas fa-server text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Protected Clients</p>
                <p id="total_clients" class="text-2xl font-bold text-gray-900">{{ total_clients }}</p>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                <i class="fas fa-fire text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Active Rules</p>
                <p id="total_rules" class="text-2xl font-bold text-gray-900">{{ total_rules }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts and Real-time Data -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Traffic Chart -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-4">Request Traffic (Last 24 Hours)</h3>
        <div id="trafficChart" style="height: 300px;"></div>
    </div>

    <!-- Threat Distribution -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-4">Threat Distribution (Last 24 Hours)</h3>
        <div id="threatChart" style="height: 300px;"></div>
    </div>
</div>

<!-- Real-time Activity -->
<div class="bg-white rounded-lg shadow">
    <div class="p-6 border-b">
        <h3 class="text-lg font-semibold">Real-time Activity</h3>
        <p class="text-sm text-gray-600">Live request monitoring</p>
    </div>
    <div class="p-4">
        <div id="activityFeed" class="space-y-3 max-h-96 overflow-y-auto">
            {% for request in recent_requests %}
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center space-x-3">
                    <span class="{% if request.blocked %}text-red-600{% else %}text-green-600{% endif %}">
                        <i class="fas fa-{% if request.blocked %}times-circle{% else %}check-circle{% endif %}"></i>
                    </span>
                    <span class="font-mono text-sm bg-gray-200 px-2 py-1 rounded">{{ request.ip_address }}</span>
                    <span class="text-sm">{{ request.request_path|truncatechars:50 }}</span>
                    <span class="text-sm font-medium">{{ request.client.name }}</span>
                </div>
                <div class="text-xs text-gray-500">
                    {{ request.timestamp|timesince }} ago
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
    <a href="{% url 'clients:client_register' %}" class="bg-white rounded-lg shadow p-6 hover:shadow-md transition duration-200">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100 text-green-600">
                <i class="fas fa-plus text-xl"></i>
            </div>
            <div class="ml-4">
                <h3 class="font-semibold text-gray-800">Register Client</h3>
                <p class="text-sm text-gray-600">Add a new client to protect</p>
            </div>
        </div>
    </a>
    
    <a href="{% url 'rules:ruleset_list' %}" class="bg-white rounded-lg shadow p-6 hover:shadow-md transition duration-200">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                <i class="fas fa-fire text-xl"></i>
            </div>
            <div class="ml-4">
                <h3 class="font-semibold text-gray-800">Manage Rules</h3>
                <p class="text-sm text-gray-600">Configure security rules</p>
            </div>
        </div>
    </a>
    
    <a href="{% url 'logs:request_logs' %}" class="bg-white rounded-lg shadow p-6 hover:shadow-md transition duration-200">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                <i class="fas fa-list-alt text-xl"></i>
            </div>
            <div class="ml-4">
                <h3 class="font-semibold text-gray-800">View Logs</h3>
                <p class="text-sm text-gray-600">Security event history</p>
            </div>
        </div>
    </a>
</div>
{% endblock %}
{% block extra_js %}
<script src="{% static 'js/apexcharts.js' %}"></script>
<script>
// Chart instances
let trafficChart = null;
let threatChart = null;

class WAFDashboard {
    constructor(wsUrl, options={}) {
        this.wsUrl = wsUrl;
        
        // DOM elements
        this.feedContainer = document.getElementById('activityFeed');
        this.totalBlockedEl = document.getElementById('total_blocked');
        this.totalAllowedEl = document.getElementById('total_allowed'); 
        this.totalClientsEl = document.getElementById('total_clients');
        this.totalRulesEl = document.getElementById('total_rules');
        this.recentThreatsEl = document.getElementById('recent_threats');
        
        // Initialize with Django template values as fallback
        this.stats = {
            total_blocked: {{ total_blocked }},
            total_allowed: {{ total_allowed }},
            total_clients: {{ total_clients }},
            total_rules: {{ total_rules }},
            recent_threats: {{ recent_threats }}
        };
        
        this.maxFeedLength = 50;
        this.trafficData = [];
        this.threatData = [];
        
        this.initCharts();
        this.connect();
    }

   initCharts() {
    // Initialize Traffic Chart - FIX: Use category axis
    const trafficEl = document.getElementById('trafficChart');
    if (trafficEl) {
        const categories = Array.from({length: 24}, (_, i) => `${i}:00`);
        
        trafficChart = new ApexCharts(trafficEl, {
            chart: { 
                type: 'line', 
                height: 300, 
                animations: { enabled: true },
                toolbar: { show: true }
            },
            series: [
                { name: 'Total Requests', data: Array(24).fill(0) }
            ],
            xaxis: { 
                type: 'category',  
                categories: categories,
                title: { text: 'Hour of Day' }
            },
            yaxis: { 
                title: { text: 'Requests' },
                min: 0
            },
            stroke: { curve: 'smooth', width: 3 },
            colors: ['#3b82f6'],
            legend: { position: 'top' }
        });
        trafficChart.render();
        console.log(" Admin traffic chart initialized with category axis");
    }

    // Initialize Threat Distribution Chart - This is working
    const threatEl = document.getElementById('threatChart');
    if (threatEl) {
        threatChart = new ApexCharts(threatEl, {
            chart: { 
                type: 'donut', 
                height: 300,
                animations: { enabled: true }
            },
            series: [],
            labels: [],
            colors: ['#ef4444', '#f59e0b', '#10b981', '#8b5cf6', '#06b6d4', '#f97316'],
            legend: { 
                position: 'bottom',
                horizontalAlign: 'center'
            },
            plotOptions: {
                pie: {
                    donut: {
                        labels: {
                            show: true,
                            total: {
                                show: true,
                                label: 'Total Threats',
                                color: '#6b7280'
                            }
                        }
                    }
                }
            }
        });
        threatChart.render();
        console.log(" Admin threat chart initialized");
    }
}

    connect() {
        console.log(` Connecting to WebSocket: ${this.wsUrl}`);
        this.ws = new WebSocket(this.wsUrl);

        this.ws.onopen = () => {
            console.log(" Connected to WAF WebSocket");
            this.updateConnectionStatus(true);
        };

        this.ws.onmessage = (event) => {
            try {
                if (event.data === "pong") {
                    console.log(" Connection healthy");
                    return;
                }
                
                const data = JSON.parse(event.data);
                console.log(" Received message type:", data.type);
                
                switch(data.type) {
                    case "dashboard_data":
                        this.handleDashboardData(data);
                        break;
                    case "request_event":
                        this.handleRequestEvent(data);
                        break;
                    default:
                        console.log(" Unknown message type:", data.type);
                }
            } catch (error) {
                console.error(" Error parsing message:", error, event.data);
            }
        };

        this.ws.onclose = () => {
            console.log("⚠ WebSocket disconnected");
            this.updateConnectionStatus(false);
            setTimeout(() => this.connect(), 3000);
        };

        this.ws.onerror = (error) => {
            console.error("WebSocket error:", error);
            this.updateConnectionStatus(false);
        };
    }

    handleDashboardData(data) {
        console.log(" Handling dashboard data", data);
        
        if (data.global_stats) {
            this.updateGlobalStats(data.global_stats);
        }
        
        if (data.charts_data) {
            this.updateCharts(data.charts_data);
        }
        
        if (data.recent_activity) {
            this.updateRecentActivity(data.recent_activity);
        }
    }

    handleRequestEvent(data) {
        console.log(" Handling request event", data);
        
       
        if (data.global_stats) {
            this.updateGlobalStats(data.global_stats);
        }
        
       
        if (data.charts_data) {
            this.updateCharts(data.charts_data);
        }
        
        
        if (data.request_data) {
            this.addRequestToFeed(data.request_data);
        }
    }

    updateGlobalStats(stats) {
        console.log(" Updating global stats:", stats);
        
        
        this.stats = { ...this.stats, ...stats };
        
        
        this.animateValue(this.totalBlockedEl, stats.total_blocked);
        this.animateValue(this.totalAllowedEl, stats.total_allowed);
        
        if (this.totalClientsEl && stats.total_clients) {
            this.animateValue(this.totalClientsEl, stats.total_clients);
        }
        
        if (this.totalRulesEl && stats.total_rules) {
            this.animateValue(this.totalRulesEl, stats.total_rules);
        }
        
        if (this.recentThreatsEl) {
            this.recentThreatsEl.innerHTML = `
                <i class="fas fa-arrow-up mr-1"></i>
                ${stats.recent_threats} last 24h
            `;
        }
    }


updateCharts(chartsData) {
    console.log(" Updating charts with data:", chartsData);
    
    
    if (trafficChart && chartsData.traffic_data) {
        console.log(" Processing traffic data for admin:", chartsData.traffic_data);
        
        
        const totalRequestsData = Array(24).fill(0);
        
       
        if (Array.isArray(chartsData.traffic_data)) {
            chartsData.traffic_data.forEach(hourData => {
                if (hourData && typeof hourData.hour === 'number' && hourData.hour >= 0 && hourData.hour < 24) {
                    const hour = hourData.hour;
                    totalRequestsData[hour] = hourData.total || 0;
                }
            });
        }
        
        console.log(" Admin total requests data:", totalRequestsData);
        
       
        const categories = Array.from({length: 24}, (_, i) => `${i}:00`);
        
        
        trafficChart.updateOptions({
            xaxis: {
                type: 'category',
                categories: categories,
                title: { text: 'Hour of Day' }
            }
        });
        
        
        trafficChart.updateSeries([
            { name: 'Total Requests', data: totalRequestsData }
        ]);
        console.log(" Admin traffic chart updated with category axis");
    } else {
        console.warn("⚠ No traffic data available for admin dashboard");
    }

    
    if (threatChart && chartsData.threat_data) {
        console.log(" Processing threat data for admin:", chartsData.threat_data);
        
      
        const labels = Array.isArray(chartsData.threat_data.labels) ? chartsData.threat_data.labels : [];
        const series = Array.isArray(chartsData.threat_data.series) ? chartsData.threat_data.series : [];
        
        threatChart.updateOptions({
            labels: labels
        });
        threatChart.updateSeries(series);
        console.log(" Admin threat chart updated with", labels.length, "threat types");
    } else {
        console.warn("⚠ No threat data available for admin dashboard");
    }
}



    updateRecentActivity(activities) {
        if (!this.feedContainer) return;
        
        console.log(" Updating recent activity with:", activities.length, "activities");
        
       
        this.feedContainer.innerHTML = '';
        
       
        activities.reverse().forEach(activity => {
            this.addRequestToFeed(activity, false);
        });
    }

    addRequestToFeed(request, animate = true) {
        if (!this.feedContainer) return;
        
        console.log("➕ Adding request to feed:", request);
        
        const div = document.createElement("div");
        div.className = `flex items-center justify-between p-3 bg-gray-50 rounded-lg ${animate ? 'animate-pulse' : ''}`;
        
        if (animate) {
            setTimeout(() => div.classList.remove("animate-pulse"), 1000);
        }

        const left = document.createElement("div");
        left.className = "flex items-center space-x-3 flex-1 min-w-0";

        const icon = document.createElement("span");
        // Use waf_blocked for real-time events, blocked for historical data
        const isBlocked = request.waf_blocked !== undefined ? request.waf_blocked : request.blocked;
        icon.className = isBlocked ? "text-red-600" : "text-green-600";
        icon.innerHTML = `<i class="fas fa-${isBlocked ? "times-circle" : "check-circle"}"></i>`;

        const ip = document.createElement("span");
        ip.className = "font-mono text-sm bg-gray-200 px-2 py-1 rounded flex-shrink-0";
        ip.textContent = request.client_ip || request.ip_address;

        const path = document.createElement("span");
        path.className = "text-sm truncate flex-1 min-w-0";
        path.textContent = request.path || request.request_path;

        const client = document.createElement("span");
        client.className = "text-sm font-medium flex-shrink-0";
        client.textContent = request.client_name || (request.client && request.client.name) || "Unknown";

        left.append(icon, ip, path, client);

        const right = document.createElement("div");
        right.className = "text-xs text-gray-500 flex-shrink-0";
        right.textContent = new Date(request.timestamp).toLocaleTimeString();

        div.append(left, right);
        this.feedContainer.prepend(div);

       
        while (this.feedContainer.children.length > this.maxFeedLength) {
            this.feedContainer.removeChild(this.feedContainer.lastChild);
        }
    }

    animateValue(element, newValue) {
        if (!element) return;
        
        const current = parseInt(element.textContent) || 0;
        if (current === newValue) return;
        
        const duration = 500;
        const stepTime = 20;
        const steps = duration / stepTime;
        const increment = (newValue - current) / steps;
        let currentValue = current;
        
        const timer = setInterval(() => {
            currentValue += increment;
            if ((increment > 0 && currentValue >= newValue) || 
                (increment < 0 && currentValue <= newValue)) {
                element.textContent = newValue;
                clearInterval(timer);
            } else {
                element.textContent = Math.round(currentValue);
            }
        }, stepTime);
    }

    updateConnectionStatus(connected) {
        const statusElement = document.getElementById('connection-status');
        if (statusElement) {
            if (connected) {
                statusElement.innerHTML = '<span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>Live';
                statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
            } else {
                statusElement.innerHTML = '<span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>Connecting...';
                statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800';
            }
        }
    }
}


document.addEventListener("DOMContentLoaded", () => {
    console.log(" Initializing WAF Dashboard with Django API integration...");
    const wsUrl = "ws://localhost:8080/ws";
    window.dashboard = new WAFDashboard(wsUrl);
});
</script>
{% endblock %}
