{% extends "dashboard/base.html" %}
{% block content %}
<div class="container mx-auto mt-4">
  
  <div class="bg-white rounded-lg shadow-xl p-6 md:p-8 mb-6">
    <div class="flex flex-col md:flex-row md:items-center justify-between">
      <h3 class="text-2xl font-bold text-gray-800">Admin Live Feed</h3>
      <p class="text-gray-500 text-sm mt-1 md:mt-0">Receiving real-time blocked requests across all clients</p>
    </div>
    <div class="mt-4">
      <span id="status" class="inline-block px-3 py-1 text-xs font-semibold rounded-full bg-gray-500 text-white">WS: connecting...</span>
    </div>
  </div>

 
  <div class="grid grid-cols-none md:grid-cols-none gap-4" id="feed">
    <div class="overflow-y-scroll max-h-64 w-full">
    {% for item in initial %}
    <div class="bg-white rounded-lg shadow-md p-3 m-3">
      <div class="flex items-center justify-between mb-2">
        <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full bg-gray-800 text-white">{{ item.client.name }}</span>
        <small class="text-gray-500 text-xs">{{ item.timestamp }}</small>
      </div>
      <p class="mb-1 text-sm font-semibold text-gray-900">
        <strong>{{ item.ip_address }}</strong> &mdash; {{ item.reason }}
      </p>
      <p class="text-gray-500 text-sm mb-1">{{ item.user_agent }}</p>
      <code class="block bg-gray-100 rounded-md p-2 text-xs text-gray-700 overflow-x-auto">{{ item.request_path }}</code>
    </div>
    {% endfor %}
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <!-- Attack Types -->
      <div class="bg-white rounded-lg shadow-xl p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Attack Types (%)</h3>
        <canvas id="attackChart"></canvas>
      </div>

      <!-- Source Countries -->
      <div class="bg-white rounded-lg shadow-xl p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Sources (%)</h3>
        <canvas id="sourceChart"></canvas>
      </div>
    </div>


</div>


<script>
(function(){
  const FEED = document.getElementById('feed');
  const STATUS = document.getElementById('status');

  const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + (location.hostname + ':8080') + '/ws');

  ws.onopen = () => {
    STATUS.textContent = 'WS: connected';
    STATUS.className = 'inline-block px-3 py-1 text-xs font-semibold rounded-full bg-green-500 text-white';
  }
  ws.onclose = () => {
    STATUS.textContent = 'WS: disconnected';
    STATUS.className = 'inline-block px-3 py-1 text-xs font-semibold rounded-full bg-red-500 text-white';
  }
  ws.onerror = () => {
    STATUS.textContent = 'WS: error';
    STATUS.className = 'inline-block px-3 py-1 text-xs font-semibold rounded-full bg-yellow-500 text-white';
  }

  ws.onmessage = (ev) => {
    try {
      const data = JSON.parse(ev.data);
      const newCard = document.createElement('div');
      newCard.className = 'bg-white rounded-lg shadow-md p-4';
      newCard.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full bg-gray-800 text-white">${data.client_name || 'unknown'}</span>
          <small class="text-gray-500 text-xs">${data.timestamp || ''}</small>
        </div>
        <p class="mb-1 text-sm font-semibold text-gray-900">
          <strong>${data.ip_address}</strong> &mdash; ${data.reason}
        </p>
        <p class="text-gray-500 text-sm mb-1">${data.user_agent || ''}</p>
        <code class="block bg-gray-100 rounded-md p-2 text-xs text-gray-700 overflow-x-auto">${data.request_path || ''}</code>
      `;
      
      FEED.prepend(newCard);
    } catch(e) {
      console.error("Failed to parse or append WebSocket message:", e);
    }
  }
})();
</script>



{% endblock %}

